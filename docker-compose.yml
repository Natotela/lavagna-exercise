version: "2.1"
services:

# (a) Create a custom nginx container to 
# - Act as a reverse proxy from port 80 to the UN-EXPOSED application 8080
# - Serve the static content (found in the webapp folder) DIRECTLY
# (b) make it part of the compose
    nginx:
        container_name: nginx
        build:
          context: ./
          dockerfile: Dockerfile.nginx
        ports:
          - "80:80"
        depends_on: [api]
        # volumes_from: api
        # volumes:  
          # - WEBAPP:/webapp/
        

    api:
        container_name: api
        build: .
        # volumes: 
          # - WEBAPP:/usr/src/app/src/main/webapp
        environment: 
          DB_HOST: "db"
          DB_DIALECT: "MYSQL"
          DB_URL: "jdbc:mysql://db:3306/lavagna"
          DB_USER: ${MYSQL_UN_PW}
          DB_PASS: ${MYSQL_UN_PW}
          SPRING_PROFILE: "dev"
        # depends_on:
        #     db:
        #         condition: service_healthy
    db:
        container_name: db
        image: mysql:5.7
        volumes:
          - ./lavagna_utf8.sql:/docker-entrypoint-initdb.d/lavagna_utf8.sql
          - DATA:/var/lib/mysql
        environment:
            MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            MYSQL_USER: ${MYSQL_UN_PW}
            MYSQL_PASSWORD: ${MYSQL_UN_PW}
            MYSQL_DATABASE: "lavagna"
        # healthcheck:
        #     test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
        #     timeout: 20s
        #     retries: 10

volumes:
    DATA:
    # WEBAPP:

################################################
# things to fix/add:
# https://help.lavagna.io/02-install/02-01-install.html#mysql
  # SET IN MYSQLD configuration:
  # [mysqld]
  # --ft_min_word_len=3
  # --ft_stopword_file=''
#
################################################